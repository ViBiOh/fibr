function isWebPCompatible(){const e="UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA";return new Promise((t,n)=>{const s=new Image;s.onload=()=>{s.width>0&&s.height>0?t():n()},s.onerror=n.bind(null,!0),s.src=`data:image/webp;base64,${e}`})}function appendChunk(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}function findIndexEscapeSequence(e,t){let n=0;for(let s=0;s<t.length;s++)if(t[s]===e[n]){if(n++,n===e.length)return s-(e.length-1)}else n!==0&&(n=0);return-1}async function*readChunk(e){const s=[28,23,4,28],o=e.body.getReader();let{value:i,done:a}=await o.read(),t=new Uint8Array(0),n;for(;;){if(a)break;for(t=appendChunk(t,i),n=findIndexEscapeSequence(s,t);n!==-1;)yield t.slice(0,n),t=t.slice(n+s.length),n=findIndexEscapeSequence(s,t);({value:i,done:a}=await o.read())}}function encode(e){const t=[];for(let n of e)t.push(String.fromCharCode(n));return btoa(t.join(""))}async function fetchThumbnail(){let e=document.location.search;e.includes("?")?(e.endsWith("&")||(e+="&"),e+="thumbnail"):e+="?thumbnail";const n=await fetch(e,{credentials:"same-origin"});if(n.status>=400)throw new Error("unable to load thumbnails");let t;typeof lazyLoadThumbnail!="undefined"&&lazyLoadThumbnail&&(t=new IntersectionObserver(async(e)=>{for(const s of e){if(!s.isIntersecting)continue;const n=s.target,o=n.parentElement.parentElement,i=generateThrobber(["throbber-white","throbber-overlay"]);if(o.appendChild(i),n.addEventListener("load",()=>o.removeChild(i),{once:!0}),window.webpHero){const t=await fetch(n.dataset.src,{credentials:"same-origin"}),s=await t.arrayBuffer(),e=new webpHero.WebpMachine;n.src=await e.decode(new Uint8Array(s)),e.clearCache()}else n.src=n.dataset.src;t.unobserve(n)}}));for await(let o of readChunk(n)){const i=o.findIndex(e=>e===44);if(i===-1){console.error("invalid line for thumbnail:",line);continue}const s=document.getElementById(`picture-${String.fromCharCode.apply(null,o.slice(0,i))}`);if(!s)continue;const e=new Image;e.src=`data:image/webp;base64,${encode(o.slice(i+1))}`,e.alt=s.dataset.alt,e.dataset.src=s.dataset.src,e.classList.add("thumbnail","full","block"),replaceContent(s,e),t!==void 0&&t.observe(e)}}document.addEventListener("readystatechange",async e=>{if(e.target.readyState!=="complete")return;let t=new Intl.DateTimeFormat(navigator.language,{dateStyle:"full",timeStyle:"long"});document.querySelectorAll(".date").forEach(e=>{e.innerHTML=t.format(new Date(e.innerHTML))})}),document.addEventListener("readystatechange",async e=>{if(e.target.readyState!=="complete")return;if(typeof hasThumbnail=="undefined"||!hasThumbnail)return;const t=document.querySelectorAll("[data-thumbnail]");if(!t)return;t.forEach(e=>{replaceContent(e,generateThrobber(["throbber-white"]))});try{await isWebPCompatible()}catch{await resolveScript("https://unpkg.com/webp-hero@0.0.2/dist-cjs/webp-hero.bundle.js","sha512-DA6h9H5Sqn55/uVn4JI4aSPFnAWoCQYYDXUnvjOAMNVx11///hX4QaFbQt5yWsrIm9hSI5fLJYfRWt3KXneSXQ==","anonymous")}try{await fetchThumbnail()}catch(e){console.error(e)}if(window.webpHero){const e=new webpHero.WebpMachine;e.polyfillDocument(),e.clearCache()}},!1),document.addEventListener("readystatechange",e=>{if(e.target.readyState!=="complete")return;document.querySelectorAll("[data-confirm]").forEach(e=>{e.addEventListener("click",t=>{confirm(`Are you sure you want to delete ${e.dataset.confirm}?`)||t.preventDefault()})})}),document.addEventListener("readystatechange",e=>{if(e.target.readyState!=="complete")return;const t=document.getElementById("go-back");t&&(t.setAttribute("href",document.referrer),t.addEventListener("click",e=>(e.preventDefault(),window.addEventListener("popstate",()=>{window.location.reload(!0)}),history.back(),!1)))});async function fetchGeoJSON(e){const t=await fetch(e,{credentials:"same-origin"});if(t.status>=400)throw new Error("unable to load geojson");return t.status===204?null:t.json()}async function addStyle(e,t,n){return new Promise(s=>{const o=document.createElement("link");o.rel="stylesheet",o.href=e,o.onload=s,t&&(o.integrity=t,o.crossOrigin=n),document.querySelector("head").appendChild(o)})}async function loadLeaflet(){const e="1.9.4";await addStyle(`https://unpkg.com/leaflet@${e}/dist/leaflet.css`,"sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==","anonymous"),await addStyle("https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css","sha512-6ZCLMiYwTeli2rVh3XAPxy3YoR5fVxGdH/pz+KMCzRY2M65Emgkw00Yqmhh8qLGeYQ3LbVZGdmOX9KUjSKr0TA==","anonymous"),await resolveScript(`https://unpkg.com/leaflet@${e}/dist/leaflet.js`,"sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==","anonymous"),await resolveScript("https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js","sha512-+Zr0llcuE/Ho6wXRYtlWypMyWSEMxrWJxrYgeAMDRSf1FF46gQ3PAVOVp5RHdxdzikZXuHZ0soHpqRkkPkI3KA==","anonymous")}let map;async function renderMap(e){if(map){map.invalidateSize();return}const t=document.getElementById("map-container"),n=generateThrobber(["map-throbber","throbber-white"]);t&&t.appendChild(n),await loadLeaflet(),map=L.map("map-container",{center:[46.227638,2.213749],zoom:5}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'}).addTo(map);const s=await fetchGeoJSON(e);if(!s||!s.features)return;const o=L.markerClusterGroup({zoomToBoundsOnClick:!1}),i=[];s.features.map(e=>{const t=L.GeoJSON.coordsToLatLng(e.geometry.coordinates);i.push(t),o.addLayer(L.circleMarker(t).bindPopup(`<a href="${e.properties.url}?browser"><img src="${e.properties.url}?thumbnail" alt="Image thumbnail" class="thumbnail-img"></a><br><span>${e.properties.date}</span>`,{maxWidth:"auto",closeButton:!1,className:"thumbnail-popup"}))}),o.on("clusterclick",e=>{map.fitBounds(e.layer.getAllChildMarkers().map(e=>e.getLatLng()))}),i.length?(map.once("zoomend",()=>{t.removeChild(n)}),map.fitBounds(i)):t.removeChild(n),map.addLayer(o)}document.addEventListener("readystatechange",async e=>{if(e.target.readyState!=="complete")return;document.location.hash==="#map"?await renderMap(geoURL):window.addEventListener("popstate",async()=>{document.location.hash==="#map"&&await renderMap(geoURL)})})