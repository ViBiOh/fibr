{{ define "map-modal" }}
  <style type="text/css" nonce="{{ .nonce }}">
    #map:target {
      display: flex;
      z-index: 5;
    }

    #map:target ~ .content {
      pointer-events: none;
    }
  </style>

  <div id="map" class="modal">
    <div class="modal-content no-background">
      <h2 class="flex flex-center header no-margin">
        <span>Map</span>
        <span class="flex-grow"></span>
        <a href="#" class="button white small">Close</a>
      </h2>

      <div id="photos-map"></div>

      <style type="text/css" nonce="{{ .nonce }}">
        #photos-map {
          color: var(--dark);
          height: 80vh;
          width: 90vw;
        }

        .thumbnail-img {
          height: 15rem;
        }

        .thumbnail-popup {
          bottom: 55px !important;
          height: 15rem;
          width: 19rem;
        }
      </style>

      <script type="text/javascript" nonce="{{ .nonce }}">
        async function fetchGeoJSON() {
          const response = await fetch('?geojson', { credentials: 'same-origin' });

          if (response.status >= 400) {
            throw new Error('unable to load geojson');
          }

          if (response.status === 204) {
            return null;
          }

          return response.json();
        }

        async function addStyle(src, integrity, crossorigin) {
          return new Promise((resolve) => {
            const style = document.createElement('link');
            style.rel = 'stylesheet';
            style.href = src;
            style.onload = resolve;

            if (integrity) {
              style.integrity = integrity;
              style.crossOrigin = crossorigin;
            }

            document.querySelector('head').appendChild(style);
          });
        }

        async function addScript(src, integrity, crossorigin) {
          return new Promise((resolve) => {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = src;
            script.async = 'true';
            script.onload = resolve;

            if (integrity) {
              script.integrity = integrity;
              script.crossOrigin = crossorigin;
            }

            document.querySelector('head').appendChild(script);
          });
        }

        async function loadLeaflet() {
          await addStyle('https://unpkg.com/leaflet@1.7.1/dist/leaflet.css', 'sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==', '');
          await addStyle('https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css', '', '');
          await addScript('https://unpkg.com/leaflet@1.7.1/dist/leaflet.js', 'sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==', '');
          await addScript('https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js', '', '');
        }

        let map;
        async function renderMap() {
          if (map) {
            map.invalidateSize(); // force re-render
            return;
          }

          await loadLeaflet();

          // create Leaflet map
          map = L.map('photos-map', {
            center: [46.227638, 2.213749], // France ðŸ‡«ðŸ‡·
            zoom: 6,
          });

          // add the OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution:
              '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
          }).addTo(map);

          const geojson = await fetchGeoJSON();
          if (!geojson || !geojson.features) {
            return;
          }

          const markers = L.markerClusterGroup({
            zoomToBoundsOnClick: false,
          });

          const bounds = [];
          geojson.features.map((f) => {
            const coord = L.GeoJSON.coordsToLatLng(f.geometry.coordinates);

            bounds.push(coord);
            markers.addLayer(L.circleMarker(coord).bindPopup(
              `<a href="${f.properties.name}?browser">
                 <img src="${f.properties.name}?thumbnail" alt="Image thumbnail" class="thumbnail-img">
               </a>
               <br>
               <span>${f.properties.date}</span>`,
              {
                maxWidth: 'auto',
                closeButton: false,
                className: 'thumbnail-popup',
              },
            ));
          });

          markers.on('clusterclick', (a) => {
            map.fitBounds(a.layer.getAllChildMarkers().map(m => m.getLatLng()));
          });

          // fit bounds of map
          map.fitBounds(bounds);
          map.addLayer(markers);
        }

        function listenTarget(event) {
          if (document.location.hash == '#map') {
            renderMap();
          }
        }

        document.addEventListener('readystatechange', async (event) => {
          if (event.target.readyState === 'complete') {
            if (document.location.hash == '#map') {
              renderMap();
            } else {
              window.addEventListener('popstate', () => {
                if (document.location.hash == '#map') {
                  renderMap();
                }
              });
            }
          }
        });
      </script>
    </div>
  </div>
{{ end }}
