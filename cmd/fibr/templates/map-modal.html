{{ define "map-modal" }}
  <style type="text/css" nonce="{{ .nonce }}">
    #map:target {
      display: flex;
      z-index: 5;
    }

    #map:target ~ .content {
      pointer-events: none;
    }
  </style>

  <div id="map" class="modal">
    <div class="modal-content no-background">
      <h2 class="flex flex-center header no-margin">
        <span>Map</span>
        <span class="flex-grow"></span>
        <a href="#" class="button white small">Close</a>
      </h2>

      {{ $geoURL := "?geojson" }}
      {{ if .Search }}
        {{ $geoURL = printf "%s&%s" $geoURL .Search.Encode }}
      {{ end }}

      <div id="map-container" class="flex flex-center">
        <noscript class="white">
          <h2>You must enable Javascript to have interactive map with pictures.</h2>
          <p>
            GeoJSON data are available on <a class="primary" href="{{ $geoURL }}">this link</a>
          </p>
        </noscript>
      </div>

      <style type="text/css" nonce="{{ .nonce }}">
        #map-container {
          background-color: var(--grey);
          color: var(--dark);
          height: 80vh;
          width: 80vw;
        }

        .thumbnail-img {
          height: 15rem;
        }

        .thumbnail-popup {
          bottom: 55px !important;
          height: 15rem;
          width: 19rem;
        }

        .map-throbber {
          z-index: 500;
        }

        .map-throbber .throbber-dot {
          height: 3.2rem;
          width: 3.2rem;
        }
      </style>

      <script type="text/javascript" nonce="{{ .nonce }}">
        async function fetchGeoJSON() {
          const response = await fetch('{{ $geoURL }}', { credentials: 'same-origin' });

          if (response.status >= 400) {
            throw new Error('unable to load geojson');
          }

          if (response.status === 204) {
            return null;
          }

          return response.json();
        }

        async function addStyle(src, integrity, crossorigin) {
          return new Promise((resolve) => {
            const style = document.createElement('link');
            style.rel = 'stylesheet';
            style.href = src;
            style.onload = resolve;

            if (integrity) {
              style.integrity = integrity;
              style.crossOrigin = crossorigin;
            }

            document.querySelector('head').appendChild(style);
          });
        }

        async function loadLeaflet() {
          const leafletVersion = "1.9.1";

          await addStyle({{ js "`https://unpkg.com/leaflet@${leafletVersion}/dist/leaflet.css`" }}, 'sha512-UkezATkM8unVC0R/Z9Kmq4gorjNoFwLMAWR/1yZpINW08I79jEKx/c8NlLSvvimcu7SL8pgeOnynxfRpe+5QpA==', 'anonymous');
          await addStyle('https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css', 'sha512-6ZCLMiYwTeli2rVh3XAPxy3YoR5fVxGdH/pz+KMCzRY2M65Emgkw00Yqmhh8qLGeYQ3LbVZGdmOX9KUjSKr0TA==', 'anonymous');
          await resolveScript({{ js "`https://unpkg.com/leaflet@${leafletVersion}/dist/leaflet.js`" }}, 'sha512-y6IQOhEalDvx6StYG9hG/64K2vuX3bVJ2Q3sBd0uP2UlhIAwOc9DEFgQ/oz1dQmsc2XbWwhn5MfpT76+1bx2Gg==', 'anonymous');
          await resolveScript('https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js', 'sha512-+Zr0llcuE/Ho6wXRYtlWypMyWSEMxrWJxrYgeAMDRSf1FF46gQ3PAVOVp5RHdxdzikZXuHZ0soHpqRkkPkI3KA==', 'anonymous');
        }

        let map;
        async function renderMap() {
          if (map) {
            map.invalidateSize(); // force re-render
            return;
          }

          const container = document.getElementById('map-container');
          const throbber = generateThrobber(['map-throbber', 'throbber-white']);
          if (container) {
            container.appendChild(throbber)
          }

          await loadLeaflet();

          // create Leaflet map
          map = L.map('map-container', {
            center: [46.227638, 2.213749], // France ðŸ‡«ðŸ‡·
            zoom: 5,
          });

          // add the OpenStreetMap tiles
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution:
              '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
          }).addTo(map);

          const geojson = await fetchGeoJSON();
          if (!geojson || !geojson.features) {
            return;
          }

          const markers = L.markerClusterGroup({
            zoomToBoundsOnClick: false,
          });

          const bounds = [];
          geojson.features.map((f) => {
            const coord = L.GeoJSON.coordsToLatLng(f.geometry.coordinates);

            bounds.push(coord);
            markers.addLayer(L.circleMarker(coord).bindPopup(
              `<a href="${f.properties.url}?browser">
                 <img src="${f.properties.url}?thumbnail" alt="Image thumbnail" class="thumbnail-img">
               </a>
               <br>
               <span>${f.properties.date}</span>`,
              {
                maxWidth: 'auto',
                closeButton: false,
                className: 'thumbnail-popup',
              },
            ));
          });

          markers.on('clusterclick', (a) => {
            map.fitBounds(a.layer.getAllChildMarkers().map(m => m.getLatLng()));
          });

          // fit bounds of map
          if (bounds.length) {
            map.once('zoomend', () => {
              container.removeChild(throbber);
            });
            map.fitBounds(bounds);
          } else {
            container.removeChild(throbber);
          }

          map.addLayer(markers);
        }

        document.addEventListener('readystatechange', async (event) => {
          if (event.target.readyState === 'complete') {
            if (document.location.hash === '#map') {
              await renderMap();
            } else {
              window.addEventListener('popstate', async () => {
                if (document.location.hash === '#map') {
                  await renderMap();
                }
              });
            }
          }
        });
      </script>
    </div>
  </div>
{{ end }}
